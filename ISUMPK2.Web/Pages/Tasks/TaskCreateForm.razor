@page "/tasks/add"
@page "/tasks/add/product/{ProductId:guid}"
@attribute [Authorize]
@using ISUMPK2.Application.DTOs
@using ISUMPK2.Application.Services
@using ISUMPK2.Application.Services.Implementations
@using ISUMPK2.Web.Models
@using ISUMPK2.Web.Extensions
@using ISUMPK2.Web.Services
@using ISUMPK2.Application.Constants
@using MudBlazor
@inject ITaskService TaskService
@inject IUserService UserService
@inject IDepartmentService DepartmentService
@inject ISubTaskService SubTaskService
@inject NavigationManager NavigationManager
@inject ISnackbar Snackbar
@inject IAuthService AuthService
@inject IProductService ProductService
@inject IMaterialService MaterialService

<PageTitle>Создание задачи - ИСУ ПМК</PageTitle>

<MudContainer MaxWidth="MaxWidth.Large" Class="mt-4">
    <MudCard>
        <MudCardHeader>
            <MudText Typo="Typo.h5">Создание новой задачи</MudText>
        </MudCardHeader>
        <MudCardContent>
            <MudForm @ref="form" @bind-IsValid="@isValid">
                <MudGrid>
                    <MudItem xs="12">
                        <MudTextField T="string" Label="Название задачи" @bind-Value="newTask.Title" Required="true" RequiredError="Название задачи обязательно" />
                    </MudItem>

                    <MudItem xs="12">
                        <MudTextField T="string" Label="Описание" @bind-Value="newTask.Description" Lines="5" />
                    </MudItem>

                    <MudItem xs="12" md="6">
                        <MudSelect T="int" Label="Приоритет" @bind-Value="newTask.PriorityId" Required="true">
                            @foreach (var priority in priorities)
                            {
                                <MudSelectItem T="int" Value="priority.Id">@priority.Name</MudSelectItem>
                            }
                        </MudSelect>
                    </MudItem>

                    <MudItem xs="12" md="6">
                        <MudSelect T="Guid?" @bind-Value="newTask.AssigneeId" Label="Исполнитель" Clearable="true">
                            @foreach (var user in users)
                            {
                                <MudSelectItem Value="@((Guid?)user.Id)">@user.FullName</MudSelectItem>
                            }
                        </MudSelect>
                    </MudItem>

                    <MudItem xs="12" md="6">
                        <MudSelect T="Guid?" Label="Отдел" @bind-Value="newTask.DepartmentId" Clearable="true">
                            @foreach (var department in departments)
                            {
                                <MudSelectItem T="Guid?" Value="department.Id">@department.Name</MudSelectItem>
                            }
                        </MudSelect>
                    </MudItem>

                    <MudItem xs="12" md="6">
                        <MudDatePicker Label="Срок выполнения" @bind-Date="dueDate" />
                    </MudItem>
                </MudGrid>
                <!-- Добавить после общих полей задачи, перед разделом подзадач -->
                <MudDivider Class="my-4" />

                @if (ProductId.HasValue)
                {
                    <MudPaper Class="pa-4 mb-3 border-solid border-1">
                        <MudText Typo="Typo.h6">Информация о продукте</MudText>

                        <div class="d-flex gap-4 mt-3">
                            <MudField Label="Продукт" Variant="Variant.Outlined"
                                      ReadOnly="true" Value="@ProductName" FullWidth="true" />

                            <MudNumericField T="decimal?" Label="Количество" Required="true"
                                             Variant="Variant.Outlined" @bind-Value="newTask.Quantity"
                                             Min="1" Class="flex-grow-1" />
                        </div>

                        <div class="d-flex justify-end mt-2">
                            <MudButton Variant="Variant.Text" Color="Color.Primary" Size="Size.Small"
                                       Href="@($"/products/{ProductId}")">
                                Открыть страницу продукта
                            </MudButton>
                        </div>
                    </MudPaper>
                }
                <!-- Секция подзадач -->
                <MudDivider Class="my-4" />
                <div class="d-flex justify-space-between align-center mb-3">
                    <MudText Typo="Typo.h6">Подзадачи</MudText>
                    <MudButton Variant="Variant.Outlined" Color="Color.Primary"
                               OnClick="AddSubTask" StartIcon="@Icons.Material.Filled.Add"
                               Size="Size.Small">
                        Добавить подзадачу
                    </MudButton>
                </div>

                @if (subTasks.Any())
                {
                    @foreach (var subTask in subTasks)
                    {
                        <MudPaper Elevation="1" Class="pa-3 mb-3 border-solid border-1">
                            <div class="d-flex justify-space-between align-center mb-2">
                                <MudText Typo="Typo.subtitle1">Подзадача</MudText>
                                <MudIconButton Icon="@Icons.Material.Filled.Delete" Color="Color.Error"
                                               OnClick="() => RemoveSubTask(subTask)" Size="Size.Small" />
                            </div>

                            <MudTextField T="string" Label="Название" @bind-Value="subTask.Title"
                                          Required="true" Class="mb-3" />

                            <MudGrid>
                                <MudItem xs="12" md="6">
                                    <MudSelect T="Guid?" @bind-Value="subTask.AssigneeId"
                                               Label="Исполнитель" Clearable="true">
                                        @foreach (var user in users)
                                        {
                                            <MudSelectItem Value="@((Guid?)user.Id)">@user.FullName</MudSelectItem>
                                        }
                                    </MudSelect>
                                </MudItem>

                                <MudItem xs="12" md="6">
                                    <MudDatePicker Label="Срок выполнения" @bind-Date="subTask.DueDate" />
                                </MudItem>

                                <MudItem xs="12">
                                    <MudTextField T="string" Label="Описание" @bind-Value="subTask.Description"
                                                  Lines="2" />
                                </MudItem>
                            </MudGrid>
                        </MudPaper>
                    }
                }
                else
                {
                    <MudText Color="Color.Secondary" Class="mb-3">
                        Нет добавленных подзадач
                    </MudText>
                }
            </MudForm>
        </MudCardContent>
        <MudCardActions>
            <MudButton Variant="Variant.Text" OnClick="Cancel">Отмена</MudButton>
            <MudSpacer />
            <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="SubmitTask"
                       Disabled="@(!isValid || isProcessing)">
                @if (isProcessing)
                {
                    <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                    <span>Сохранение...</span>
                }
                else
                {
                    <span>Создать задачу</span>
                }
            </MudButton>
        </MudCardActions>
        <MudDivider Class="my-4" />
        <div class="d-flex justify-space-between align-center mb-3">
            <MudText Typo="Typo.h6">Материалы</MudText>
            <MudButton Variant="Variant.Outlined" Color="Color.Primary"
                       OnClick="AddMaterial" StartIcon="@Icons.Material.Filled.Add"
                       Size="Size.Small">
                Добавить материал
            </MudButton>
        </div>
        @if (taskMaterials.Any())
        {
            <MudTable Items="@taskMaterials" Hover="true" Dense="true">
                <HeaderContent>
                    <MudTh>Материал</MudTh>
                    <MudTh>Количество</MudTh>
                    <MudTh>Ед. измерения</MudTh>
                    <MudTh></MudTh>
                </HeaderContent>
                <RowTemplate>
                    <MudTd>
                        <MudSelect T="Guid" Value="context.MaterialId" Label="Материал"
                                   ValueChanged="@(value => MaterialChanged(value, context))">
                            @foreach (var material in availableMaterials)
                            {
                                <MudSelectItem Value="@material.Id">@material.Name (@material.Code)</MudSelectItem>
                            }
                        </MudSelect>
                    </MudTd>
                    <MudTd>
                        <MudNumericField T="decimal" @bind-Value="context.Quantity" Min="0" />
                    </MudTd>
                    <MudTd>
                        <MudText Style="padding: 10px 0;">@(string.IsNullOrEmpty(context.UnitOfMeasure) ? "-" : context.UnitOfMeasure)</MudText>
                    </MudTd>
                    <MudTd>
                        <MudIconButton Icon="@Icons.Material.Filled.Delete" Color="Color.Error"
                                       OnClick="@(() => RemoveMaterial(context))" />
                    </MudTd>
                </RowTemplate>
            </MudTable>
        }
        else
        {
            <MudText Color="Color.Secondary" Class="mb-3">
                Нет добавленных материалов
            </MudText>
        }
    </MudCard>
</MudContainer>

@code {

    private MudForm? form;
    private bool isValid;
    private bool isProcessing;

    [Parameter]
    [SupplyParameterFromQuery]
    public Guid? ProductId { get; set; }

    [Parameter]
    [SupplyParameterFromQuery]
    public string Operation { get; set; }

    [Parameter]
    [SupplyParameterFromQuery]
    public string ProductName { get; set; }

    [Parameter]
    [SupplyParameterFromQuery]
    public Guid? DepartmentId { get; set; }

    private TaskCreateModel newTask = new TaskCreateModel();

    private DateTime? dueDate;
    private List<UserModel> users = new List<UserModel>();
    private List<DepartmentModel> departments = new List<DepartmentModel>();
    private List<SubTaskCreateModel> subTasks = new List<SubTaskCreateModel>();
    private List<TaskMaterialModel> taskMaterials = new List<TaskMaterialModel>();
    private List<MaterialDto> availableMaterials = new List<MaterialDto>();
    private List<PriorityModel> priorities = new List<PriorityModel>
    {
        new PriorityModel { Id = 1, Name = "Низкий" },
        new PriorityModel { Id = 2, Name = "Средний" },
        new PriorityModel { Id = 3, Name = "Высокий" },
        new PriorityModel { Id = 4, Name = "Критический" }
    };

    protected override async Task OnInitializedAsync()
    {
        try
        {
            // Добавляем отладочный вывод параметров из URL
            Console.WriteLine("Получены параметры из URL:");
            Console.WriteLine($"ProductId: {ProductId}");
            Console.WriteLine($"Operation: {Operation}");
            Console.WriteLine($"ProductName: {ProductName}");
            Console.WriteLine($"DepartmentId: {DepartmentId}");
            // Загружаем все необходимые данные
            await LoadUsersAndDepartments();

            // Если открыли страницу из продукта, предзаполняем данные
            if (ProductId.HasValue)
            {
                try
                {
                    var product = await ProductService.GetProductByIdAsync(ProductId.Value);
                    Console.WriteLine($"Продукт загружен: {product?.Name ?? "не найден"}");

                    if (product != null)
                    {
                        // Заполняем название задачи с типом обработки и названием продукта
                        newTask.Title = $"{Operation ?? "Производство"} {ProductName ?? product.Name}";
                        newTask.Description = product.Description;
                        newTask.DepartmentId = DepartmentId ?? product.DepartmentId;
                        newTask.ProductId = ProductId;
                        newTask.Quantity = 1; // По умолчанию 1 единица
                        StateHasChanged();

                        // Добавляем материалы продукта как материалы задачи
                        if (product.Materials != null && product.Materials.Any())
                        {
                            foreach (var material in product.Materials)
                            {
                                taskMaterials.Add(new TaskMaterialModel
                                    {
                                        MaterialId = material.MaterialId,
                                        MaterialName = material.MaterialName,
                                        Quantity = material.Quantity,
                                        UnitOfMeasure = material.UnitOfMeasure ?? "шт." // Используем значение из материала или "шт." по умолчанию
                                    });
                            }
                        }
                        // Затем после загрузки доступных материалов
                        availableMaterials = (await MaterialService.GetAllMaterialsAsync()).ToList();

                        // Обновляем информацию о материалах для правильной установки единиц измерения
                        foreach (var taskMaterial in taskMaterials)
                        {
                            UpdateMaterialInfo(taskMaterial);
                        }
                        // Добавляем стандартные подзадачи для производства
                        AddStandardSubTasks(product.ProductTypeName);
                    }
                }
                catch (Exception ex)
                {
                    Console.WriteLine($"Ошибка при загрузке данных продукта: {ex.Message}");
                    Snackbar.Add($"Ошибка при загрузке данных продукта: {ex.Message}", Severity.Error);
                }
            }
            // Загружаем доступные материалы
            try
            {
                availableMaterials = (await MaterialService.GetAllMaterialsAsync()).ToList();
                Console.WriteLine($"Загружено материалов: {availableMaterials.Count}");

                // Проверяем наличие единиц измерения в загруженных материалах
                foreach (var material in availableMaterials.Take(5)) // Выводим первые 5 для примера
                {
                    Console.WriteLine($"Материал: {material.Name}, Единица измерения: {material.UnitOfMeasure}");
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Ошибка в OnInitializedAsync: {ex.Message}");
                Snackbar.Add($"Ошибка загрузки данных: {ex.Message}", Severity.Error);
            }


            // Получаем текущего пользователя для установки CreatorId
            var currentUser = await UserService.GetCurrentUserAsync();
            if (currentUser != null)
            {
                newTask.CreatorId = currentUser.Id;
                Console.WriteLine($"Loaded user: {currentUser.UserName}, CreatorId: {newTask.CreatorId}");

                // Автоматически устанавливаем отдел текущего пользователя
                if (currentUser.DepartmentId.HasValue && newTask.DepartmentId == null)
                {
                    newTask.DepartmentId = currentUser.DepartmentId.Value;
                }
            }
            else
            {
                Console.WriteLine("Current user is null!");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Ошибка в OnInitializedAsync: {ex.Message}");
            Snackbar.Add($"Ошибка загрузки данных: {ex.Message}", Severity.Error);
        }
    }

    private void UpdateMaterialInfo(TaskMaterialModel material)
    {
        var selectedMaterial = availableMaterials.FirstOrDefault(m => m.Id == material.MaterialId);
        if (selectedMaterial != null)
        {
            material.MaterialName = selectedMaterial.Name;
            material.MaterialCode = selectedMaterial.Code;

            // Всегда устанавливаем единицу измерения из выбранного материала
            material.UnitOfMeasure = selectedMaterial.UnitOfMeasure ?? "шт.";

            // Добавляем отладочную информацию
            Console.WriteLine($"UpdateMaterialInfo: Материал {selectedMaterial.Name}, Единица измерения: {material.UnitOfMeasure}");

            // Обеспечиваем обновление интерфейса
            StateHasChanged();
        }
        else
        {
            Console.WriteLine($"UpdateMaterialInfo: Материал не найден для ID {material.MaterialId}");
        }
    }

    private void AddMaterial()
    {
        // При добавлении материала устанавливаем пустые значения
        var newMaterial = new TaskMaterialModel()
        {
            MaterialId = Guid.Empty,
            MaterialName = string.Empty,
            MaterialCode = string.Empty,
            UnitOfMeasure = string.Empty,
            Quantity = 1
        };
        taskMaterials.Add(newMaterial);
        Console.WriteLine("Добавлен новый материал");
        StateHasChanged();
    }

    private void RemoveMaterial(TaskMaterialModel material)
    {
        taskMaterials.Remove(material);
        StateHasChanged();
    }

    private void AddStandardSubTasks(string productType)
    {
        // Добавляем стандартные подзадачи в зависимости от типа продукта
        if (productType == "Ростверк")
        {
            subTasks.Add(new SubTaskCreateModel
            {
                Title = "Подготовка материалов",
                Description = "Подготовить материалы для производства"
            });
            subTasks.Add(new SubTaskCreateModel
            {
                Title = "Сборка основы",
                Description = "Выполнить сборку основы ростверка"
            });
            subTasks.Add(new SubTaskCreateModel
            {
                Title = "Покраска",
                Description = "Выполнить покраску готового изделия"
            });
        }
        else
        {
            // Для других типов продуктов - общие подзадачи
            subTasks.Add(new SubTaskCreateModel
            {
                Title = "Подготовка материалов",
                Description = "Подготовить материалы для производства"
            });
            subTasks.Add(new SubTaskCreateModel
            {
                Title = "Сборка изделия",
                Description = "Выполнить сборку изделия"
            });
        }
    }

    private async Task LoadUsersAndDepartments()
    {
        try
        {
            users = (await UserService.GetAllUsersAsync())
                .Select(dto => new UserModel
                {
                    Id = dto.Id,
                    FullName = $"{dto.FirstName} {dto.LastName}"
                })
                .ToList();

            departments = (await DepartmentService.GetAllDepartmentsAsync())
                .Select(dto => new DepartmentModel
                {
                    Id = dto.Id,
                    Name = dto.Name
                })
                .ToList();

            Console.WriteLine($"Loaded {users.Count} users and {departments.Count} departments");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Ошибка при загрузке справочников: {ex.Message}");
            Snackbar.Add($"Ошибка загрузки данных: {ex.Message}", Severity.Error);
        }
    }

    // Новые методы для управления подзадачами
    private void AddSubTask()
    {
        subTasks.Add(new SubTaskCreateModel());
    }

    private void RemoveSubTask(SubTaskCreateModel subTask)
    {
        subTasks.Remove(subTask);
        StateHasChanged();
    }

    private async Task MaterialChanged(Guid materialId, TaskMaterialModel model)
    {
        model.MaterialId = materialId;

        // Находим выбранный материал
        var selectedMaterial = availableMaterials.FirstOrDefault(m => m.Id == materialId);
        if (selectedMaterial != null)
        {
            // Обновляем данные материала в модели
            model.MaterialName = selectedMaterial.Name;
            model.MaterialCode = selectedMaterial.Code;
            model.UnitOfMeasure = selectedMaterial.UnitOfMeasure ?? "шт.";

            // Выводим отладочную информацию
            Console.WriteLine($"Материал выбран: {selectedMaterial.Name}, Единица измерения: {model.UnitOfMeasure}");
        }
        else
        {
            Console.WriteLine($"Материал с ID {materialId} не найден в списке доступных материалов");
        }

        // Обязательно обновляем интерфейс
        StateHasChanged();
    }


    private async Task SubmitTask()
    {
        if (!isValid) return;

        isProcessing = true;
        try
        {
            newTask.DueDate = dueDate;

            // Проверка наличия CreatorId
            if (newTask.CreatorId == Guid.Empty)
            {
                var currentUser = await UserService.GetCurrentUserAsync();
                if (currentUser != null)
                {
                    newTask.CreatorId = currentUser.Id;
                }
                else
                {
                    throw new Exception("Не удалось определить текущего пользователя");
                }
            }

            Console.WriteLine($"Creating task with CreatorId: {newTask.CreatorId}");

            var taskDto = new TaskCreateDto
            {
                Title = newTask.Title ?? string.Empty,
                Description = newTask.Description ?? string.Empty,
                StatusId = 1, // По умолчанию "Создана"
                PriorityId = newTask.PriorityId,
                AssigneeId = newTask.AssigneeId,
                DepartmentId = newTask.DepartmentId,
                DueDate = newTask.DueDate,
                ProductId = newTask.ProductId,
                Quantity = newTask.Quantity,
                Materials = taskMaterials.Select(m => new TaskMaterialCreateDto
                {
                    MaterialId = m.MaterialId,
                    Quantity = m.Quantity,
                    UnitOfMeasure = m.UnitOfMeasure // Добавляем единицу измерения, если API это поддерживает
                }).ToList()
            };

            try
            {
                var createdTask = await TaskService.CreateTaskAsync(newTask.CreatorId, taskDto);
                Console.WriteLine($"Задача успешно создана: {createdTask?.Id}");

                // Создаем подзадачи, если они есть
                if (createdTask != null && subTasks.Any())
                {
                    foreach (var subTask in subTasks)
                    {
                        var subTaskDto = new SubTaskCreateDto
                        {
                            ParentTaskId = createdTask.Id,
                            Title = subTask.Title,
                            Description = subTask.Description,
                            AssigneeId = subTask.AssigneeId,
                            DueDate = subTask.DueDate,
                            StatusId = 1 // По умолчанию "Создана"
                        };

                        await SubTaskService.CreateSubTaskAsync(subTaskDto);
                    }
                }

                // Списание материалов со склада после создания задачи
                if (createdTask != null && taskMaterials.Any())
                {
                    foreach (var material in taskMaterials)
                    {
                        try
                        {
                            await MaterialService.UpdateStockAsync(
                                material.MaterialId,
                                material.Quantity,
                                false); // false означает вычитание
                        }
                        catch (Exception ex)
                        {
                            Console.WriteLine($"Ошибка при списании материала {material.MaterialId}: {ex.Message}");
                            // Продолжаем дальше даже при ошибке списания материалов
                        }
                    }
                }

                Snackbar.Add("Задача успешно создана", Severity.Success);
                NavigationManager.NavigateTo("/tasks");
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Ошибка внутри CreateTaskAsync: {ex}");
                throw;
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Ошибка при создании задачи: {ex.Message}");
            Snackbar.Add($"Ошибка при создании задачи: {ex.Message}", Severity.Error);
        }
        finally
        {
            isProcessing = false;
        }
    }

    private void Cancel()
    {
        NavigationManager.NavigateTo("/tasks");
    }

    

    public class TaskMaterialModel
    {
        public Guid MaterialId { get; set; }
        public string MaterialName { get; set; } = string.Empty;
        public string MaterialCode { get; set; } = string.Empty;
        public decimal Quantity { get; set; }
        // Удаляем значение по умолчанию "шт."
        public string UnitOfMeasure { get; set; } = string.Empty;

        // Метод для обновления названия материала и единицы измерения
        public void UpdateMaterialInfo(List<MaterialDto> materials)
        {
            var material = materials.FirstOrDefault(m => m.Id == MaterialId);
            if (material != null)
            {
                MaterialName = material.Name;
                UnitOfMeasure = material.UnitOfMeasure ?? string.Empty;
            }
        }
    }

    // Модель для создания подзадач
    public class SubTaskCreateModel
    {
        public string Title { get; set; } = string.Empty;
        public string Description { get; set; } = string.Empty;
        public Guid? AssigneeId { get; set; }
        public DateTime? DueDate { get; set; }
    }

    public class TaskCreateModel
    {
        public string? Title { get; set; }
        public string? Description { get; set; }
        public int StatusId { get; set; } = 1; // По умолчанию "Создана"
        public int PriorityId { get; set; } = 2; // По умолчанию "Средний"
        public Guid? AssigneeId { get; set; }
        public Guid CreatorId { get; set; }
        public Guid? DepartmentId { get; set; }
        public DateTime? DueDate { get; set; }
        public Guid? ProductId { get; set; } // Добавлено
        public decimal? Quantity { get; set; } // Добавлено
    }

    private class PriorityModel
    {
        public int Id { get; set; }
        public string? Name { get; set; }
    }

    public class UserModel
    {
        public Guid Id { get; set; }
        public string FullName { get; set; }
    }

    public class DepartmentModel
    {
        public Guid Id { get; set; }
        public string Name { get; set; }
    }
}