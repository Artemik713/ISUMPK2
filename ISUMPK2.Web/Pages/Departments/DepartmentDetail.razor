@page "/departments/{id:guid}"
@attribute [Authorize]
@using ISUMPK2.Application.DTOs
@using ISUMPK2.Application.Services
@using ISUMPK2.Web.Models
@using ISUMPK2.Web.Extensions
@using MudBlazor
@using Microsoft.AspNetCore.Components.Authorization
@using System.Security.Claims
@inject IDepartmentService DepartmentService
@inject ITaskService TaskService
@inject IProductService ProductService
@inject IUserService UserService
@inject NavigationManager NavigationManager
@inject IDialogService DialogService
@inject ISnackbar Snackbar
@inject AuthenticationStateProvider AuthStateProvider

<PageTitle>@(department?.Name ?? "Загрузка...") - ИСУ ПМК</PageTitle>

@if (isLoading)
{
    <MudProgressCircular Color="Color.Primary" Indeterminate="true" />
}
else if (isAccessDenied)
{
    <MudAlert Severity="Severity.Error" Class="mb-4">У вас нет доступа к данной странице</MudAlert>
    <MudButton OnClick="@(() => NavigationManager.NavigateTo("/"))" Variant="Variant.Filled" Color="Color.Primary" Class="mt-2">
        Вернуться на главную
    </MudButton>
}
else if (department == null)
{
    <MudAlert Severity="Severity.Error">Цех не найден</MudAlert>
    <MudButton OnClick="@(() => NavigationManager.NavigateTo("/departments"))" Variant="Variant.Filled" Color="Color.Primary" Class="mt-4">
        Вернуться к списку цехов
    </MudButton>
}
else
{
    <MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-4">
        <MudPaper Elevation="3" Class="pa-4 department-header">
            <div class="d-flex justify-space-between align-center">
                <div>
                    <MudText Typo="Typo.h3">@department.Name</MudText>
                    <MudText Typo="Typo.subtitle1">@department.Description</MudText>
                </div>
                <MudButton Variant="Variant.Outlined" Color="Color.Primary" OnClick="@(() => NavigationManager.NavigateTo("/departments"))" StartIcon="@Icons.Material.Filled.ArrowBack">
                    К списку цехов
                </MudButton>
            </div>

            @if (!string.IsNullOrEmpty(department.HeadName))
            {
                <MudText Class="mt-3"><strong>Руководитель:</strong> @department.HeadName</MudText>
            }
        </MudPaper>

        <MudGrid Class="mt-4">
            <!-- Задачи цеха -->
            <MudItem xs="12">
                <MudCard>
                    <MudCardHeader>
                        <CardHeaderContent>
                            <MudText Typo="Typo.h6">Активные задачи цеха</MudText>
                        </CardHeaderContent>
                        <CardHeaderActions>
                            <MudIconButton Icon="@Icons.Material.Filled.Refresh" Color="Color.Default" OnClick="LoadDepartmentData" />
                        </CardHeaderActions>
                    </MudCardHeader>
                    <MudCardContent>
                        @if (departmentTasks == null || !departmentTasks.Any())
                        {
                            <MudText>В данном цехе нет активных задач</MudText>
                        }
                        else
                        {
                            <MudTable Items="@departmentTasks.Where(t => t.StatusId < 5)" Hover="true" Dense="true" Breakpoint="Breakpoint.Sm">
                                <HeaderContent>
                                    <MudTh>Название</MudTh>
                                    <MudTh>Статус</MudTh>
                                    <MudTh>Приоритет</MudTh>
                                    <MudTh>Исполнитель</MudTh>
                                    <MudTh>Срок выполнения</MudTh>
                                    <MudTh>Действия</MudTh>
                                </HeaderContent>
                                <RowTemplate>
                                    <MudTd DataLabel="Название">@context.Title</MudTd>
                                    <MudTd DataLabel="Статус">
                                        <MudChip T="string" Color="@GetStatusColor(context.StatusId)"
                                                 Size="Size.Small">@context.StatusName</MudChip>
                                    </MudTd>
                                    <MudTd DataLabel="Приоритет">
                                        <MudChip T="string" Color="@GetPriorityColor(context.PriorityId)"
                                                 Size="Size.Small">@context.PriorityName</MudChip>
                                    </MudTd>
                                    <MudTd DataLabel="Исполнитель">@(string.IsNullOrEmpty(context.AssigneeName) ? "Не назначен" : context.AssigneeName)</MudTd>
                                    <MudTd DataLabel="Срок">
                                        @(context.DueDate.HasValue? context.DueDate.Value.ToString("dd.MM.yyyy") : "-")
                                        @if (context.IsOverdue)
                                        {
                                            <MudIcon Icon="@Icons.Material.Filled.Warning" Color="Color.Error" Size="Size.Small" />
                                        }
                                    </MudTd>
                                    <MudTd>
                                        <MudIconButton Icon="@Icons.Material.Filled.Visibility" Size="Size.Small"
                                                       OnClick="@(() => NavigationManager.NavigateTo($"/tasks/{context.Id}"))" />
                                    </MudTd>
                                </RowTemplate>
                            </MudTable>
                        }
                    </MudCardContent>
                </MudCard>
            </MudItem>

            <!-- Сотрудники цеха -->
            <MudItem xs="12" md="6" Class="mt-4">
                <MudCard>
                    <MudCardHeader>
                        <CardHeaderContent>
                            <MudText Typo="Typo.h6">Сотрудники цеха</MudText>
                        </CardHeaderContent>
                    </MudCardHeader>
                    <MudCardContent>
                        @if (departmentEmployees == null || !departmentEmployees.Any())
                        {
                            <MudText>Нет доступных данных о сотрудниках</MudText>
                        }
                        else
                        {
                            <MudList T="UserModel" Dense="true">
                                @foreach (var employee in departmentEmployees)
                                {
                                    <MudListItem T="UserModel" Value="@employee">
                                        <div class="d-flex align-center">
                                            <MudAvatar Color="Color.Primary" Size="Size.Small" Class="mr-3">
                                                @(employee.FullName?.Length > 0 ? employee.FullName.Substring(0, 1) : "?")
                                            </MudAvatar>
                                            <div>
                                                <MudText>@employee.FullName</MudText>
                                                <MudText Typo="Typo.caption">Сотрудник цеха</MudText>
                                            </div>
                                        </div>
                                    </MudListItem>
                                }
                            </MudList>
                        }
                    </MudCardContent>
                </MudCard>
            </MudItem>

            <!-- Продукция цеха -->
            <MudItem xs="12" md="6" Class="mt-4">
                <MudCard>
                    <MudCardHeader>
                        <CardHeaderContent>
                            <MudText Typo="Typo.h6">Продукция цеха</MudText>
                        </CardHeaderContent>
                    </MudCardHeader>
                    <MudCardContent>
                        @if (departmentProducts == null || !departmentProducts.Any())
                        {
                            <MudText>Нет доступных данных о продукции</MudText>
                        }
                        else
                        {
                            <MudTable Items="@departmentProducts" Hover="true" Dense="true" Breakpoint="Breakpoint.Sm">
                                <HeaderContent>
                                    <MudTh>Код</MudTh>
                                    <MudTh>Название</MudTh>
                                    <MudTh>Тип</MudTh>
                                </HeaderContent>
                                <RowTemplate>
                                    <MudTd DataLabel="Код">@context.Code</MudTd>
                                    <MudTd DataLabel="Название">@context.Name</MudTd>
                                    <MudTd DataLabel="Тип">@context.ProductTypeName</MudTd>
                                </RowTemplate>
                            </MudTable>
                        }
                    </MudCardContent>
                </MudCard>
            </MudItem>
        </MudGrid>
    </MudContainer>
}

<style>
    /* Заменяем фиолетовый цвет на более нейтральный синий */
    .department-header {
        background-color: var(--mud-palette-info-darken);
        color: white;
    }
</style>
@code {
    [Parameter]
    public Guid Id { get; set; }

    private DepartmentModel department;
    private List<TaskModel> departmentTasks = new();
    private List<ProductModel> departmentProducts = new();
    private List<UserModel> departmentEmployees = new();
    private bool isLoading = true;
    private bool isAccessDenied = false;
    private Guid? currentUserDepartmentId;
    private bool isAdminOrManager = false;

    protected override async Task OnInitializedAsync()
    {
        await CheckUserAccess();
    }

    protected override async Task OnParametersSetAsync()
    {
        if (!isAccessDenied)
        {
            await LoadDepartmentData();
        }
    }

    private async Task CheckUserAccess()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        // Проверка на админа или менеджера
        isAdminOrManager = user.IsInRole("Admin") || user.IsInRole("Manager");

        if (!isAdminOrManager)
        {
            try
            {
                // Получаем данные текущего пользователя по имени пользователя
                var userName = user.Identity?.Name;
                if (!string.IsNullOrEmpty(userName))
                {
                    // Используем существующий метод GetUsersByFilterAsync с фильтрацией по имени пользователя
                    var users = await UserService.GetUsersByFilterAsync($"userName eq '{userName}'");
                    var currentUser = users.FirstOrDefault();

                    if (currentUser != null)
                    {
                        currentUserDepartmentId = currentUser.DepartmentId;

                        // Если пользователь пытается просмотреть не свой цех
                        if (currentUserDepartmentId.HasValue && currentUserDepartmentId.Value != Id)
                        {
                            isAccessDenied = true;

                            // Перенаправляем на страницу его цеха
                            if (currentUserDepartmentId.HasValue)
                            {
                                NavigationManager.NavigateTo($"/departments/{currentUserDepartmentId.Value}");
                            }
                        }
                    }
                }
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Ошибка проверки прав доступа: {ex.Message}", Severity.Error);
            }
        }
    }
    private Color GetStatusColor(int statusId)
    {
        return statusId switch
        {
            1 => Color.Default,  // Создана
            2 => Color.Info,     // В работе
            3 => Color.Warning,  // Требует уточнения
            4 => Color.Primary,  // На проверке
            5 => Color.Success,  // Выполнена
            6 => Color.Error,    // Отклонена
            _ => Color.Default
        };
    }

    private Color GetPriorityColor(int priorityId)
    {
        return priorityId switch
        {
            1 => Color.Default,     // Низкий
            2 => Color.Info,        // Средний
            3 => Color.Warning,     // Высокий
            4 => Color.Error,       // Критический
            _ => Color.Default
        };
    }
    private async Task LoadDepartmentData()
    {
        isLoading = true;

        try
        {
            // Проверка авторизации перед загрузкой данных
            var authState = await AuthStateProvider.GetAuthenticationStateAsync();
            if (authState?.User?.Identity?.IsAuthenticated != true)
            {
                // Если пользователь не авторизован, перенаправляем на страницу входа
                NavigationManager.NavigateTo("/account/login?returnUrl=" +
                    Uri.EscapeDataString(NavigationManager.Uri), true);
                return;
            }

            // Загрузка данных отдела
            var departmentDto = await DepartmentService.GetDepartmentByIdAsync(Id);
            if (departmentDto != null)
            {
                department = new DepartmentModel
                {
                    Id = departmentDto.Id,
                    Name = departmentDto.Name,
                    Description = departmentDto.Description,
                    HeadId = departmentDto.HeadId,
                    HeadName = departmentDto.HeadName
                };

                // Загрузка связанных данных с обработкой возможных ошибок авторизации
                try
                {
                    var tasksDto = await TaskService.GetTasksAsync(Id);
                    departmentTasks = tasksDto.Select(t => t.ToModel()).ToList();
                }
                catch (HttpRequestException ex) when (ex.StatusCode == System.Net.HttpStatusCode.Unauthorized)
                {
                    Snackbar.Add("Недостаточно прав для просмотра задач цеха", Severity.Warning);
                    departmentTasks = new List<TaskModel>();
                }

                try
                {
                    var productsDto = await ProductService.GetProductsAsync($"departmentId eq {Id}");
                    departmentProducts = productsDto.Select(p => p.ToModel()).ToList();
                }
                catch (HttpRequestException ex) when (ex.StatusCode == System.Net.HttpStatusCode.Unauthorized)
                {
                    Snackbar.Add("Недостаточно прав для просмотра продукции цеха", Severity.Warning);
                    departmentProducts = new List<ProductModel>();
                }

                try
                {
                    var employeesDto = await UserService.GetUsersByFilterAsync($"departmentId eq {Id}");
                    departmentEmployees = employeesDto.Select(e => e.ToModel()).ToList();
                }
                catch (Exception ex) when (ex.Message.Contains("401") || ex.Message.Contains("403")
                    || ex.Message.Contains("Unauthorized") || ex.Message.Contains("Forbidden"))
                {
                    departmentEmployees = new List<UserModel>();
                    Snackbar.Add("Недостаточно прав для просмотра сотрудников цеха", Severity.Warning);
                }
            }
            else
            {
                Snackbar.Add("Цех не найден или у вас нет доступа к нему", Severity.Warning);
            }
        }
        catch (HttpRequestException ex) when (ex.StatusCode == System.Net.HttpStatusCode.Unauthorized)
        {
            // Обработка ошибки авторизации
            Snackbar.Add("Сессия истекла или недостаточно прав. Пожалуйста, войдите снова", Severity.Error);
            NavigationManager.NavigateTo("/account/login?returnUrl=" +
                Uri.EscapeDataString(NavigationManager.Uri), true);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Ошибка при загрузке данных цеха: {ex.Message}", Severity.Error);
        }
        finally
        {
            isLoading = false;
        }
    }
}