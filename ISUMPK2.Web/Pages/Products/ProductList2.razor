@* @page "/products"
@attribute [Authorize]
@using ISUMPK2.Application.DTOs
@using ISUMPK2.Application.Services
@using ISUMPK2.Web.Models
@using MudBlazor
@inject IProductService ProductService
@inject NavigationManager NavigationManager
@inject ISnackbar Snackbar
@inject IDialogService DialogService

<PageTitle>Каталог продукции - ИСУ ПМК</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraLarge">
    <!-- Заголовок с минимумом элементов -->
    <div class="d-flex justify-space-between align-center mb-4">
        <MudText Typo="Typo.h5">Каталог продукции</MudText>
        <div>
            @if (canManageProducts)
            {
                <MudFab Color="Color.Primary" Icon="@Icons.Material.Filled.Add" Size="Size.Small"
                        OnClick="@(() => NavigationManager.NavigateTo("/products/add"))" Class="mr-2" />
            }
            <MudIconButton Icon="@Icons.Material.Filled.Refresh" OnClick="LoadProductsAsync" />
            <MudIconButton Icon="@(isGridView? Icons.Material.Filled.ViewList : Icons.Material.Filled.ViewModule)"
                           OnClick="ToggleView" />
        </div>
    </div>

    <!-- Компактные фильтры -->
    <MudGrid Spacing="1" Class="mb-4">
        <MudItem xs="12" md="4">
            <MudAutocomplete T="string" Label="Тип продукции" @bind-Value="selectedCategory"
                             SearchFunc="@SearchCategories" ResetValueOnEmptyText="true"
                             AdornmentIcon="@Icons.Material.Filled.Category" Dense="true"
                             OnClearButtonClick="@(() => FilterChanged())" Variant="Variant.Outlined" />
        </MudItem>
        <MudItem xs="12" md="4">
            <MudTextField @bind-Value="searchText" Label="Поиск" AdornmentIcon="@Icons.Material.Filled.Search"
                          OnKeyDown="HandleKeyDown" Adornment="Adornment.End" Dense="true"
                          OnAdornmentClick="FilterChanged" Variant="Variant.Outlined" />
        </MudItem>
        <MudItem xs="12" md="4" Class="d-flex align-end justify-end">
            <MudText Typo="Typo.caption" Color="Color.Secondary">Найдено @filteredProducts.Count позиций</MudText>
        </MudItem>
    </MudGrid>

    @if (isLoading)
    {
        <div class="d-flex justify-center ma-4">
            <MudProgressCircular Color="Color.Default" Indeterminate="true" />
        </div>
    }
    else if (filteredProducts.Count == 0)
    {
        <MudText Align="Align.Center" Class="my-8">Продукция не найдена</MudText>
    }
    else
    {
        @if (isGridView)
        {
            <MudGrid Spacing="2">
                @foreach (var product in filteredProducts)
                {
                    <MudItem xs="12" sm="6" md="4" lg="3">
                        <MudPaper Elevation="1" Class="simple-card pa-2" @onclick="() => ViewProductDetails(product.Id)">
                            <div class="d-flex flex-column" style="height:100%;">
                                <div class="product-image" style="background-image:url(@GetProductImage(product));"></div>
                                <div class="pa-2">
                                    <div class="d-flex justify-space-between">
                                        <MudText Typo="Typo.subtitle2">@product.Code</MudText>
                                        <MudText Typo="Typo.caption">@product.Price.ToString("C0")</MudText>
                                    </div>
                                    <MudText Typo="Typo.body2" Class="mt-1">@product.Name</MudText>
                                    <div class="d-flex justify-space-between mt-2">
                                        <MudText Typo="Typo.caption" Color="Color.Secondary">@product.ProductTypeName</MudText>
                                        <MudText Typo="Typo.caption">@product.CurrentStock @product.UnitOfMeasure</MudText>
                                    </div>
                                </div>
                            </div>
                        </MudPaper>
                    </MudItem>
                }
            </MudGrid>
        }
        else
        {
            <MudSimpleTable Bordered="false" Dense="true" Hover="true">
                <thead>
                    <tr>
                        <th>Код</th>
                        <th>Наименование</th>
                        <th>Категория</th>
                        <th>Запас</th>
                        <th>Цена</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var product in filteredProducts)
                    {
                        <tr @onclick="() => ViewProductDetails(product.Id)" style="cursor: pointer;">
                            <td>@product.Code</td>
                            <td>@product.Name</td>
                            <td>@product.ProductTypeName</td>
                            <td>@product.CurrentStock @product.UnitOfMeasure</td>
                            <td>@product.Price.ToString("C0")</td>
                            <td>
                                @if (canManageProducts)
                                {
                                    <MudIconButton Size="Size.Small"
                                                   Icon="@Icons.Material.Filled.Edit"
                                                   OnClick="() => EditProduct(product.Id)"
                                                   StopPropagation="true" />
                                }
                            </td>
                        </tr>
                    }
                </tbody>
            </MudSimpleTable>
        }
    }
</MudContainer>

<style>
    .simple-card {
        cursor: pointer;
        height: 100%;
        transition: all 0.2s ease;
    }

        .simple-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 3px 8px rgba(0,0,0,0.1);
        }

    .product-image {
        height: 150px;
        background-position: center;
        background-repeat: no-repeat;
        background-size: contain;
    }
</style>

<style>
    .product-card {
        transition: transform 0.2s ease, box-shadow 0.2s ease;
        cursor: pointer;
    }

        .product-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--mud-elevation-5);
        }

    .product-title {
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
        text-overflow: ellipsis;
        height: 3em;
    }

    .truncate-description {
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
        text-overflow: ellipsis;
    }
</style>

@code {
    private bool isLoading = true;
    private bool canManageProducts = true;
    private bool isGridView = true;
    private string searchText = "";
    private string selectedCategory = "";
    private List<ProductModel> products = new();
    private List<ProductModel> filteredProducts = new();
    private List<string> categories = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadProductsAsync();
    }

    private async Task LoadProductsAsync()
    {
        isLoading = true;

        try
        {
            // Загрузка продукции и категорий
            var productsDto = await ProductService.GetAllProductsAsync();
            foreach (var p in productsDto)
            {
                Console.WriteLine($"Продукт: {p.Name}, TypeId: {p.ProductTypeId}, TypeName: {p.ProductTypeName}");
            }
            products = productsDto.Select(p => new ProductModel
            {
                Id = p.Id,
                Code = p.Code,
                Name = p.Name,
                Description = p.Description ?? "",
                ProductTypeId = p.ProductTypeId,
                ProductTypeName = p.ProductTypeName ?? "Без категории",
                Price = p.Price,
                CurrentStock = p.CurrentStock,
                UnitOfMeasure = p.UnitOfMeasure ?? "шт.",
                ImageUrl = p.ImageUrl
            }).ToList();
            categories = products.Select(p => p.ProductTypeName).Distinct().OrderBy(c => c).ToList();

            // Применяем фильтры
            FilterProducts();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Ошибка при загрузке продукции: {ex.Message}", Severity.Error);
        }
        finally
        {
            isLoading = false;
        }
    }

    private void FilterProducts()
    {
        filteredProducts = products;

        // Фильтр по категории
        if (!string.IsNullOrEmpty(selectedCategory))
        {
            filteredProducts = filteredProducts.Where(p => p.ProductTypeName == selectedCategory).ToList();
        }

        // Фильтр по поисковому запросу
        if (!string.IsNullOrEmpty(searchText))
        {
            var search = searchText.ToLower();
            filteredProducts = filteredProducts.Where(p =>
                p.Name.ToLower().Contains(search) ||
                p.Code.ToLower().Contains(search) ||
                p.Description.ToLower().Contains(search)
            ).ToList();
        }
    }

    private void FilterChanged()
    {
        FilterProducts();
    }

    private async Task<IEnumerable<string>> SearchCategories(string value, CancellationToken cancellationToken)
    {
        // Если строка пуста, возвращаем все категории
        await Task.Delay(1, cancellationToken); // Добавляем для асинхронной сигнатуры

        if (string.IsNullOrEmpty(value))
            return categories;

        return categories.Where(c => c.Contains(value, StringComparison.OrdinalIgnoreCase));
    }

    private void HandleKeyDown(KeyboardEventArgs args)
    {
        if (args.Key == "Enter")
            FilterChanged();
    }

    private void ViewProductDetails(Guid id)
    {
        NavigationManager.NavigateTo($"/products/{id}");
    }

    private void EditProduct(Guid id)
    {
        NavigationManager.NavigateTo($"/products/edit/{id}");
    }

    private void ToggleView()
    {
        isGridView = !isGridView;
    }

    private Color GetStockColor(ProductModel product)
    {
        if (product.CurrentStock <= 0)
            return Color.Error;
        if (product.CurrentStock <= 10)
            return Color.Warning;
        return Color.Success;
    }

    private string GetProductImage(ProductModel product)
    {
        if (!string.IsNullOrEmpty(product.ImageUrl))
            return product.ImageUrl;

        // Используем встроенный data URL вместо запроса к файлу
        return "data:image/png;base64,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";
    }
} *@