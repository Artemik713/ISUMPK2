@page "/account/change-password"
@attribute [Authorize]
@using ISUMPK2.Application.Services
@using ISUMPK2.Web.Services
@using MudBlazor
@inject IAuthService AuthService
@inject ISnackbar Snackbar
@inject NavigationManager NavigationManager

<PageTitle>Смена пароля - ИСУ ПМК</PageTitle>

<MudContainer MaxWidth="MaxWidth.Small" Class="pa-4">
    <MudPaper Elevation="3" Class="pa-6">
        <MudText Typo="Typo.h5" Class="mb-4">Смена пароля</MudText>

        <MudTextField T="string"
                      Label="Текущий пароль"
                      @bind-Value="currentPassword"
                      InputType="InputType.Password"
                      Variant="Variant.Outlined"
                      Class="mb-3" />

        <MudTextField T="string"
                      Label="Новый пароль"
                      @bind-Value="newPassword"
                      InputType="InputType.Password"
                      Variant="Variant.Outlined"
                      Class="mb-3" />

        <MudTextField T="string"
                      Label="Подтвердите пароль"
                      @bind-Value="confirmPassword"
                      InputType="InputType.Password"
                      Variant="Variant.Outlined"
                      Class="mb-4" />

        <MudButton Variant="Variant.Filled"
                   Color="Color.Primary"
                   FullWidth="true"
                   OnClick="ChangePasswordAsync"
                   Disabled="@isSubmitting">
            @if (isSubmitting)
            {
                <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                <span>Обработка...</span>
            }
            else
            {
                <span>Сменить пароль</span>
            }
        </MudButton>

        <div class="d-flex justify-center mt-4">
            <MudButton Variant="Variant.Text"
                       OnClick="@(() => NavigationManager.NavigateTo("/profile"))"
                       Disabled="@isSubmitting"
                       Class="mx-2">
                Вернуться в профиль
            </MudButton>
        </div>
    </MudPaper>
</MudContainer>

@code {
    private string currentPassword = "";
    private string newPassword = "";
    private string confirmPassword = "";
    private bool isSubmitting = false;

    private async Task ChangePasswordAsync()
    {
        // Валидация
        if (string.IsNullOrEmpty(currentPassword) || string.IsNullOrEmpty(newPassword) || string.IsNullOrEmpty(confirmPassword))
        {
            Snackbar.Add("Все поля обязательны для заполнения", Severity.Warning);
            return;
        }

        if (newPassword != confirmPassword)
        {
            Snackbar.Add("Новый пароль и подтверждение не совпадают", Severity.Warning);
            return;
        }

        // Минимальная проверка надежности пароля
        if (newPassword.Length < 6)
        {
            Snackbar.Add("Новый пароль должен содержать не менее 6 символов", Severity.Warning);
            return;
        }

        try
        {
            isSubmitting = true;

            // Вызов сервиса для смены пароля
            var result = await AuthService.ChangePasswordAsync(currentPassword, newPassword);

            if (result)
            {
                Snackbar.Add("Пароль успешно изменен", Severity.Success);

                // Очистка полей формы
                currentPassword = "";
                newPassword = "";
                confirmPassword = "";

                // Перенаправление на профиль
                NavigationManager.NavigateTo("/profile");
            }
            else
            {
                Snackbar.Add("Не удалось изменить пароль. Возможно, текущий пароль указан неверно.", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Ошибка при смене пароля: {ex.Message}", Severity.Error);
        }
        finally
        {
            isSubmitting = false;
        }
    }
}